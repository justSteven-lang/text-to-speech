services:
  tts-app:
    image: ${IMAGE}
    container_name: ${APP_NAME}

    restart: unless-stopped

    expose:
      - "8080"

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    security_opt:
      - no-new-privileges:true

    read_only: true

    tmpfs:
      - /tmp

  nginx:
    build:
      context: .
      dockerfile: Dockerfile.nginx

    container_name: nginx

    restart: unless-stopped

    ports:
      - "80:80"

    volumes:
      - ./nginx:/etc/nginx:ro

    depends_on:
      - tts-app

    healthcheck:
      test: ["CMD-SHELL", "pidof nginx || exit 1"]

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    read_only: true

    tmpfs:
      - /tmp
      - /var/cache/nginx
      - /var/run
      - /var/log/nginx

    security_opt:
      - no-new-privileges:true

  prometheus:
    image: prom/prometheus:latest

    container_name: prometheus

    restart: unless-stopped

    ports:
      - "9090:9090"

    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro

    command:
      - "--config.file=/etc/prometheus/prometheus.yml"

    read_only: true

    tmpfs:
      - /tmp

  grafana:
    image: grafana/grafana:latest

    container_name: grafana

    restart: unless-stopped

    ports:
      - "3000:3000"

    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin

    volumes:
      - grafana-data:/var/lib/grafana

    read_only: true

    tmpfs:
      - /tmp

volumes:
  grafana-data:
